jobs:
  tests:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - name: "Checkout" 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Install dependencies"
        run: |
          sudo apt -y update
          sudo apt -y install libgtk-3-dev libx11-dev libjansson-dev libluajit-5.1-dev

      - name: "Run make"
        run: make -j

      - name: Set Build number
        shell: bash
        run: echo "build_number=$(git rev-list HEAD --count)" >> $GITHUB_ENV

      - name: Compute git short sha
        shell: bash
        run: echo "git_short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: "Prepare AppDir"
        run: |
          mkdir -p LibreSplit.AppDir/usr/bin
          mkdir -p LibreSplit.AppDir/usr/share/applications
          mkdir -p LibreSplit.AppDir/usr/share/icons/hicolor
          mkdir -p LibreSplit.AppDir/usr/share/glib-2.0/schemas
          cp libresplit LibreSplit.AppDir/usr/bin/
          cp libresplit.desktop LibreSplit.AppDir/usr/share/applications/
          for size in 16 22 24 32 36 48 64 72 96 128 256 512; do
            mkdir -p LibreSplit.AppDir/usr/share/icons/hicolor/"${size}x${size}"/apps
            rsvg-convert -w "$size" -h "$size" -f png -o LibreSplit.AppDir/usr/share/icons/hicolor/"${size}x${size}"/apps/libresplit.png libresplit.svg
          done
          cp libresplit.gschema.xml LibreSplit.AppDir/usr/share/glib-2.0/schemas/
